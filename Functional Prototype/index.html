<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<style>
body {
  font-family: sans-serif;
  background: white;
}

#status {
  font-size: 14pt;
  color: gray;
  margin-top: 12px;
  margin-bottom: 12px;
}

#board {
  width: 800px;
  height: 600px;
  border: 1px solid gray;
  padding: 3px;
}

#board div {
  margin-top: 5px;
}

#msg {
  width: 740px;
  margin-right: 10px;
}

#send {
  width: 50px;
}

#login_section, #chat_section, #game_section, #waiting_section {
  display: none;
}

.user_name {
  font-size: 10pt;
  font-weight: bold;
  color: blue;
}

.says {
  font-size: 10pt;
  color: gray;
}

.msg {
  font-size: 12pt;
  font-family: serif;
}

.notification {
  color: green;
}

.testCanvas {
  width: 960;
  height: 800;
}
</style>

<script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<div id="login_section">
  <div id="status">Connecting to the chat room ...</div>
  Your name:
  <input id="name" type="text"></input>
  <input id="login" type="button" value="Play" disabled="true"></input>
</div>

<div id="chat_section">
  <div id="board">
  </div>
  <input id="msg" type="text"></input>
  <input id="send" type="button" value="Send"></input>
</div>

<div id="game_section" align="center" class="canvasHolder">
	<canvas id="testCanvas" width="1000" height ="1000"></canvas>
</div>

<div id="waiting_section" align="center" >
	Waiting For Other Player
</div>



<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Chinese Checkers</title>

	<link href="assets/demoStyles.css" rel="stylesheet" type="text/css" />

	<!-- Note: All core EaselJS classes are listed here: -->
	<script type="text/javascript" src="./src/createjs/events/Event.js"></script>
	<script type="text/javascript" src="./src/createjs/events/EventDispatcher.js"></script>
	<script type="text/javascript" src="./src/createjs/utils/IndexOf.js"></script>
	<script type="text/javascript" src="./src/easeljs/utils/UID.js"></script>
	<script type="text/javascript" src="./src/easeljs/utils/Ticker.js"></script>
	<script type="text/javascript" src="./src/easeljs/geom/Matrix2D.js"></script>
	<script type="text/javascript" src="./src/easeljs/geom/Point.js"></script>
	<script type="text/javascript" src="./src/easeljs/geom/Rectangle.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Shadow.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/SpriteSheet.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Graphics.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/DisplayObject.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Container.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Stage.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Bitmap.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Sprite.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/BitmapAnimation.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/BitmapText.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Shape.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/Text.js"></script>
	<script type="text/javascript" src="./src/easeljs/display/DOMElement.js"></script>
	<script type="text/javascript" src="./src/easeljs/events/MouseEvent.js"></script>
	<script type="text/javascript" src="./src/easeljs/filters/Filter.js"></script>
	<script type="text/javascript" src="./src/easeljs/ui/ButtonHelper.js"></script>
	<script type="text/javascript" src="./src/easeljs/ui/Touch.js"></script>
	<script type="text/javascript" src="./src/easeljs/utils/SpriteSheetUtils.js"></script>
	<script type="text/javascript" src="./src/easeljs/utils/SpriteSheetBuilder.js"></script>

	<!-- We also provide hosted minified versions of all CreateJS libraries.
	  http://code.createjs.com -->

	<script>

	var socket;
	var canvas, stage, canvasHold;

	var mouseTarget;	// the display object currently under the mouse, or being dragged
	var dragStarted;	// indicates whether we are currently in a drag operation
	var offset;
	var update = true;
	var spotMatrix = [];
	var othersMarbles = [];
	var moveingFrom = [];
	
	
	
	
	
	// $(document) returns a jQuery object representing the whole document (page).
  // $(document).ready(fn) tells jQuery to call function 'fn' after the whole
  // document is loaded.
  $(document).ready(function() {
    // Hide the warning section and show the login section.
    $('#warning').css('display', 'none');
	$('#game_section').css('display', 'none');
	$('#waiting_section').css('display', 'none');
    $('#login_section').css('display', 'block');

    // Initialize socket.io.
    // document.location.host returns the host of the current page.
    socket = io.connect('http://' + document.location.host);

    // If a welcome message is received, it means the chat room is available.
    // The Log In button will be then enabled.
    socket.on(
      'welcome',
      function(message) {
        $('#status').text(message);
        $('#login').attr('disabled', false);
      });

    // If a login_ok message is received, proceed to the chat section.
    socket.on(
      'login_ok',
      function() {
        $('#login_section').css('display', 'none');
        $('#waiting_section').css('display', 'block');
        $('#status').text('Waiting.');
      });
	  
	// display an error message.
    socket.on(
      'start_game',
      function() {
        $('#waiting_section').css('display', 'none');
        $('#game_section').css('display', 'block');
        $('#status').text('Playing.');
      });

    // If a login_failed message is received, stay in the login section but
    // display an error message.
    socket.on(
      'login_failed',
      function() {
        $('#status').text('Failed to log in!');
      });

    // If a chat message is received, display it.
    socket.on(
      'chat',
      function(message) {
        if (message && message.user_name && message.msg) {
          var user_name = message.user_name;
          var msg = message.msg;
          // This will create a div element using the HTML code:
          var div = $('<div></div>');
          // Similarly, create span elements with CSS classes and corresponding
          // contents, and append them in a row to the new div element.
          div.append($('<span></span>').addClass('user_name').text(user_name));
          div.append($('<span></span>').addClass('says').text(' says: '));
          div.append($('<span></span>').addClass('msg').text(msg));
          // Add the new div element to the chat board.
          $('#board').append(div);
        }
      });
	  
	// If other player moves
    socket.on(
      'move',
      function(startX, startY, endX, endY) {
			convertedStartX = startX + 2*(4-startX);
			convertedStartY = startY + 2*(4-startY);
			convertedEndX = endX + 2*(4-endX);
			convertedEndY = endY + 2*(4-endY);
			
			var startSpot = spotMatrix[convertedStartY][convertedStartX];
			var endSpot = spotMatrix[convertedEndY][convertedEndX];
			
			startSpot.isEmpty = true;
			endSpot.isEmpty = false;
			
			var marble = findClosestOpponentMarble(startSpot.screenX, startSpot.screenY);
			marble.x = endSpot.screenX;
			marble.y = endSpot.screenY;
			update = true;
        });
	  

    // If a notification is received, display it.
    socket.on(
      'notification',
      function(message) {
        if (message) {
          // Similar to the handler of 'chat' event ...
          var div = $('<div></div>');
          div.append($('<span></span>').addClass('notification').text(message));
          $('#board').append(div);
        }
      });

    // When the Log In button is clicked, the provided function will be called,
    // which sends a login message to the server.
    $('#login').click(function() {
      var name = $('#name').val();
      if (name) {
        name = name.trim();
        if (name.length > 0) {
          socket.emit('login', { user_name: name });
        }
      }
      // Clear the input field.
      $('#name').val('');
    });

    // When Enter is pressed in the name field, it should be treated as clicking
    // on the Log In button.
    $('#name').keyup(function(event) {
      if (event.keyCode == 13) {
        $('#login').click();
      }
    });

    // When the Log In button is clicked, the provided function will be called,
    // which sends a chat message to the server.
    $('#send').click(function() {
      var data = $('#msg').val();
      if (data) {
        data = data.trim();
        if (data.length > 0) {
          socket.emit('chat', { msg: data });
        }
      }
      // Clear the input field.
      $('#msg').val('');
    });

    // When Enter is pressed in the message field, it should be treated as
    // clicking on the Send button.
    $('#msg').keyup(function(event) {
      if (event.keyCode == 13) {
        $('#send').click();
      }
    });
  });
	
	
	
	
	
	
	function init() {
		if (window.top != window) {
			document.getElementById("header").style.display = "none";
		}
		document.getElementById("loader").className = "loader";
		// create stage and point it to the canvas:
		canvas = document.getElementById("testCanvas");
		
		
		

		//check to see if we are running in a browser with touch support
		stage = new createjs.Stage(canvas);

		// enable touch interactions if supported on the current device:
		createjs.Touch.enable(stage);

		// enabled mouse over / out events
		stage.enableMouseOver(10);
		stage.mouseMoveOutside = true; // keep tracking the mouse even when it leaves the canvas

		var spotImage = new Image();
		spotImage.src = "assets/spot.png";
		spotImage.onload = handleSpotImageLoad;
		
		// load the source image:
		var othersMarbleImage = new Image();
		othersMarbleImage.src = "assets/redmarble.png";
		othersMarbleImage.onload = handleOthersMarbleImageLoad;
		
		// load the source image:
		var myMarbleImage = new Image();
		myMarbleImage.src = "assets/bluemarble.png";
		myMarbleImage.onload = handleMyMarbleImageLoad;
	}

	function stop() {
		createjs.Ticker.removeEventListener("tick", tick);
	}
	
	function findClosestOpponentMarble(screenX, screenY) {
		var shortestDistance = 10000;
		var closest;
	
		for(var i = 0; i<9; i++) {
			var distance = Math.sqrt(((screenX - othersMarbles[i].x)*(screenX - othersMarbles[i].x)) + 
							((screenY - othersMarbles[i].y)*(screenY - othersMarbles[i].y)));
			if(distance < shortestDistance) {
				shortestDistance = distance;
				closest = othersMarbles[i];
			}
		}
		return closest;
	}
	
	function findClosestSpot(x, y) {
		var shortestDistance = 10000;
		var closest;
	
		for(var i = 0; i<9; i++) {
			for(var j = 0; j<9; j++) {
				var distance = Math.sqrt(((x - spotMatrix[j][i].screenX)*(x - spotMatrix[j][i].screenX)) + 
								((y - spotMatrix[j][i].screenY)*(y - spotMatrix[j][i].screenY)));
				if(distance < shortestDistance) {
					shortestDistance = distance;
					closest = spotMatrix[j][i];
				}
			}
		}
		
		return closest;
	}
	
	function isValidMove(startX, startY, endX, endY) {
		var start = findClosestSpot(startX, startY);
		var end = findClosestSpot(endX, endY);
		
		if( Math.abs(start.x-end.x) <= 1 && Math.abs(start.y-end.y) <= 1 && end.isEmpty == true)
			return true;
		else
			return false;
	}

	function handleSpotImageLoad(event) {
		spotMatrix = new Array(17);
		var image = event.target;
		var bitmap;
		var container = new createjs.Container();
		stage.addChild(container);
			
		var perLine = [1,2,3,4,13,12,11,10,9,10,11,12,13,4,3,2,1];

		// create and populate the screen with random daisies:
		for(var y = 0; y < 17; y++){
			spotMatrix[y] = new Array(perLine[y]);
			var startPointX = 500-(((perLine[y]-1)/2)*50);
			for(var x = 0; x < perLine[y]; x++){
				bitmap = new createjs.Bitmap(image);
				container.addChild(bitmap);
				bitmap.regX = bitmap.image.width/2|0;
				bitmap.regY = bitmap.image.height/2|0;
				bitmap.scaleX = bitmap.scaleY = bitmap.scale = 0.6;
				bitmap.x = startPointX;
				bitmap.y = (y+1)*50;
				bitmap.name = "spot_"+y+" "+x;
				
				spot = new Object();
				spot.isEmpty = true;
				spot.x = x;
				spot.y = y;
				spot.screenX = bitmap.x;
				spot.screenY = bitmap.y;
				spotMatrix[y][x] = spot;
				
				startPointX += 50;
			}

			document.getElementById("loader").className = "";
			createjs.Ticker.addEventListener("tick", tick);
		}
	}
	
	function handleMyMarbleImageLoad(event) {
		var image = event.target;
		var bitmap;
		var container = new createjs.Container();
		stage.addChild(container);

		var xPositions = [0,1,2,3,0,1,2,0,1,0];
		var yPositions = [13,13,13,13,14,14,14,15,15,16];
		
		// create and populate the screen with random daisies:
		for(var i = 0; i < 9; i++){
			bitmap = new createjs.Bitmap(image);
			container.addChild(bitmap);
			console.debug("xPos:" + xPositions[i] + "  yPos:" + yPositions[i] + "    Spot:" + spotMatrix[yPositions[i]][xPositions[i]]);
			bitmap.x = spotMatrix[yPositions[i]][xPositions[i]].screenX;
			bitmap.y = spotMatrix[yPositions[i]][xPositions[i]].screenY;
			bitmap.regX = bitmap.image.width/2|0;
			bitmap.regY = bitmap.image.height/2|0;
			bitmap.scaleX = bitmap.scaleY = bitmap.scale = 0.55;
			bitmap.name = "myMarble"+i;
			bitmap.cursor = "pointer";
			
			findClosestSpot(bitmap.x, bitmap.y).isEmpty = false;

			bitmap.addEventListener("mousedown", function(evt) {
				evt.addEventListener("mouseup", function(evt) {
					var o = evt.target;
					o.scaleX = o.scaleY = 0.55;
					update = true;
					
					if(isValidMove(moveingFrom.screenX, moveingFrom.screenY, o.x, o.y))
					{
						var startSpot = findClosestSpot(moveingFrom.screenX, moveingFrom.screenY);
						var endSpot = findClosestSpot(o.x, o.y);
						o.x = endSpot.screenX;
						o.y = endSpot.screenY;
						endSpot.isEmpty = false;
						startSpot.isEmpty = true;
						socket.emit('move', startSpot.x, startSpot.y, endSpot.x, endSpot.y);
					}
					else
					{
						o.x = moveingFrom.screenX;
						o.y = moveingFrom.screenY;
					}
				});
				
				// bump the target in front of its siblings:
				var o = evt.target;
				o.scaleX = o.scaleY = 0.65;
				o.parent.addChild(o);
				o.offset = {x:o.x-evt.stageX, y:o.y-evt.stageY};
				
				
				moveingFrom.screenX = o.x;
				moveingFrom.screenY = o.y;
			});
			
			// the pressmove event is dispatched when the mouse moves after a mousedown on the target until the mouse is released.
			bitmap.addEventListener("pressmove", function(evt) {
				var o = evt.target;
				o.x = evt.stageX+ o.offset.x;
				o.y = evt.stageY+ o.offset.y;
				// indicate that the stage should be updated on the next tick:
				update = true;
			});
			
			bitmap.addEventListener("rollover", function(evt) {
				var o = evt.target;
				o.scaleX = o.scaleY = 0.65;
				update = true;
			});
			
			bitmap.addEventListener("rollout", function(evt) {
				var o = evt.target;
				o.scaleX = o.scaleY = o.scale;
				update = true;
			});

		}

		document.getElementById("loader").className = "";
		createjs.Ticker.addEventListener("tick", tick);
	}
	
	function handleOthersMarbleImageLoad(event) {
		othersMarbles = new Array(9);
		var image = event.target;
		var bitmap;
		var container = new createjs.Container();
		stage.addChild(container);

		// create and populate the screen with random daisies:
		for(var i = 0; i < 9; i++){
			bitmap = new createjs.Bitmap(image);
			container.addChild(bitmap);
			bitmap.x = (i+1)*50;
			bitmap.y = 50;
			bitmap.regX = bitmap.image.width/2|0;
			bitmap.regY = bitmap.image.height/2|0;
			bitmap.scaleX = bitmap.scaleY = bitmap.scale = 0.55;
			bitmap.name = "othersMarble"+i;
			bitmap.cursor = "pointer";
			
			//marble = new Object();
			//marble.image = bitmap;
			//marble.id = i;
			othersMarbles[i] = bitmap;
			
			findClosestSpot(bitmap.x, bitmap.y).isEmpty = false;
		}

		document.getElementById("loader").className = "";
		createjs.Ticker.addEventListener("tick", tick);
	}

	function tick(event) {
		// this set makes it so the stage only re-renders when an event handler indicates a change has happened.
		if (update) {
			update = false; // only update once
			stage.update(event);
		}
	}
	</script>

</head>

<body background="white" onload="init();">

	<div id="loader"></div>

	<!--<header id="header" class="EaselJS">
	//    <h1><span class="text-product">Easel<strong>JS</strong></span> Drag &amp; Drop Example With Custom Hit Areas</h1>
	//    <p>This example is the same as the DragAndDrop example, except it uses <strong>hitArea</strong> to make only the center part of the daisy respond to mouse interactions.</p>
	//</header>-->
	
	
	
</body>
</html>
